<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مولد سيناريو الفيديو لإنتاج AI</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Libraries for DOCX export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <!-- Google Fonts: Cairo for Arabic UI -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6366f1; }

        /* General styles for generated script */
        #scriptOutput h3 {
            font-size: 1.5rem; font-weight: bold; color: #c7d2fe;
            margin-top: 2rem; margin-bottom: 0.75rem;
            border-bottom: 2px solid #4f46e5; padding-bottom: 0.5rem;
        }
        #scriptOutput p { margin-bottom: 1rem; line-height: 1.7; }
        #scriptOutput strong { color: #e0e7ff; }

        /* Styles for the IMAGE PROMPT box */
        .image-prompt-box {
            position: relative; background-color: #111827; border: 1px solid #374151;
            border-radius: 0.75rem; padding: 1.5rem; margin-top: 1rem; margin-bottom: 1.5rem;
            color: #d1d5db; text-align: left; direction: ltr;
            font-family: monospace;
        }
        .prompt-actions { position: absolute; top: 0.75rem; right: 0.75rem; display: flex; gap: 0.5rem; }
        .prompt-btn { background-color: #374151; color: #d1d5db; border: none; border-radius: 0.5rem; padding: 0.5rem; cursor: pointer; transition: all 0.2s ease-in-out; display: flex; align-items: center; justify-content: center; }
        .prompt-btn:hover { background-color: #4f46e5; color: white; }
        
        .copy-tooltip {
            position: absolute; background-color: #1f2937; color: white;
            padding: 0.25rem 0.75rem; border-radius: 0.375rem; font-size: 0.875rem;
            opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s; white-space: nowrap;
            top: -2.5rem; left: 50%; transform: translateX(-50%); 
        }
        .prompt-btn.copied .copy-tooltip, .dialogue-action-btn.copied .copy-tooltip { opacity: 1; visibility: visible; }
        
        /* Styles for the DIALOGUE lines */
        .dialogue-line-box {
            position: relative; display: flex; justify-content: space-between; align-items: center;
            padding: 0.75rem 1rem; background-color: #1f2937;
            border-right: 3px solid #4f46e5; border-left: none;
            border-radius: 0.5rem; margin-bottom: 0.75rem;
            transition: background-color 0.2s ease; text-align: right;
        }
        .dialogue-line-box:hover { background-color: #2c3a4f; }
        .dialogue-text-content { flex-grow: 1; margin-left: 1rem; }
        .dialogue-actions-container { display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0; }
        .dialogue-action-btn {
            background: none; border: none; color: #9ca3af; cursor: pointer;
            padding: 0.25rem;
            transition: color 0.2s ease;
            position: relative;
        }
        .dialogue-action-btn:hover { color: #c7d2fe; }
        .dialogue-copy-btn.copied, .dialogue-tts-btn.playing { color: #4ade80; }

        /* Styles for Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 50; backdrop-filter: blur(4px); }
        .modal-content { background: #1f2937; color: #e5e7eb; border-radius: 1rem; padding: 2rem; width: 90%; max-width: 3xl; max-height: 90vh; overflow-y: auto; }
        .modal-close-btn { position: absolute; top: 1rem; left: 1rem; background: none; border: none; font-size: 2rem; color: #9ca3af; cursor: pointer; line-height: 1; }
        .modal-close-btn:hover { color: white; }
        .suggestion-item { background-color: #374151; padding: 0.75rem; border-radius: 0.5rem; cursor: pointer; transition: background-color 0.2s; }
        .suggestion-item:hover { background-color: #4f46e5; }
        
        /* Guide/API Modal specific styles */
        .tab-button.active { border-color: #4f46e5; color: #c7d2fe; }
        .guide-link { color: #818cf8; text-decoration: underline; font-weight: bold; }
        .guide-link:hover { color: #a5b4fc; }
        .tool-description { margin-top: 0.5rem; margin-bottom: 1.5rem; padding-right: 1rem; border-right: 2px solid #374151;}
        .limit-note { font-size: 0.875rem; color: #facc15; } /* yellow-400 */
        
        /* Animated Gradient for the Title */
        .animated-gradient-text {
            background: linear-gradient(90deg, #818cf8, #a855f7, #818cf8);
            background-size: 200% auto;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient-animation 5s ease infinite;
        }
        @keyframes gradient-animation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        
        /* Hide/Show utility */
        .hidden { display: none; }
        .spinner, .modal-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        input[type="number"]:disabled { background-color: #374151; cursor: not-allowed; opacity: 0.7; }

        /* Toggle Switch Styles */
        .toggle-switch {
            position: relative; display: inline-block;
            width: 44px; height: 24px; background-color: #4b5563;
            border-radius: 9999px; transition: background-color 0.2s ease-in-out;
            cursor: pointer; flex-shrink: 0;
        }
        .toggle-knob {
            position: absolute; top: 2px; right: 2px;
            width: 20px; height: 20px;
            background-color: white; border-radius: 50%;
            transition: transform 0.2s ease-in-out;
        }
        .toggle-switch[aria-checked='true'] { background-color: #4f46e5; }
        .toggle-switch[aria-checked='true'] .toggle-knob { transform: translateX(-20px); }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl mx-auto">
        <header class="text-center mb-8 relative">
            <h1 class="text-4xl md:text-5xl font-bold animated-gradient-text">مولد سيناريو لإنتاج AI</h1>
            <p class="text-gray-400 mt-2">حوّل فكرتك إلى موجهات صور وحوارات جاهزة للإنتاج.</p>
            <div class="absolute top-0 left-0 mt-2 ml-2 flex space-x-2">
                 <button id="openGuideBtn" class="text-indigo-400 hover:text-indigo-300 transition-colors" title="دليل الاستخدام">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                </button>
                 <button id="openApiSettingsBtn" class="text-indigo-400 hover:text-indigo-300 transition-colors" title="إعدادات API">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                </button>
            </div>
        </header>

        <main class="bg-gray-800 bg-opacity-50 backdrop-blur-sm p-6 md:p-8 rounded-2xl shadow-2xl border border-gray-700">
            <form id="scriptForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Form Inputs -->
                <div class="col-span-1 md:col-span-2">
                    <label for="topic" class="block mb-2 text-sm font-medium text-gray-300">موضوع الفيديو</label>
                    <div class="flex gap-2">
                        <input type="text" id="topic" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5" placeholder="مثال: مغامرة في غابة مسحورة" required>
                        <button type="button" id="suggestIdeasBtn" title="اقترح أفكارًا" class="p-2.5 text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                        </button>
                    </div>
                </div>
                <div>
                    <label for="videoType" class="block mb-2 text-sm font-medium text-gray-300">الأسلوب الفني</label>
                     <select id="videoType" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5 h-11">
                        <option value="cinematic anime style">أسلوب أنمي سينمائي</option>
                        <option value="3D cartoon (Pixar style)">أسلوب كرتون (Pixar)</option>
                        <option value="Fantasy digital art">فن رقمي خيالي</option>
                        <option value="Cyberpunk art">Cyberpunk</option>
                        <option value="Photorealistic">واقعي (Photorealistic)</option>
                    </select>
                </div>
                 <div>
                    <label for="videoTone" class="block mb-2 text-sm font-medium text-gray-300">نبرة الفيديو</label>
                     <select id="videoTone" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5 h-11">
                        <option value="متوازن">متوازن (Default)</option>
                        <option value="كوميدي">كوميدي</option>
                        <option value="درامي">درامي</option>
                        <option value="تعليمي">تعليمي</option>
                        <option value="حماسي وملحمي">حماسي وملحمي</option>
                        <option value="غامض ومثير">غامض ومثير</option>
                    </select>
                </div>
                <div>
                    <label for="sceneCount" class="block mb-2 text-sm font-medium text-gray-300">عدد المشاهد</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="sceneCount" min="1" max="10" value="3" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5 h-11" required>
                        <div class="flex items-center gap-2">
                            <label for="sceneCountToggle" class="text-sm font-medium text-gray-400 whitespace-nowrap">آلي</label>
                            <button type="button" id="sceneCountToggle" class="toggle-switch" role="switch" aria-checked="false"><span class="toggle-knob"></span></button>
                        </div>
                    </div>
                </div>
                <div>
                    <label for="characterCount" class="block mb-2 text-sm font-medium text-gray-300">عدد الشخصيات</label>
                     <div class="flex items-center gap-2">
                        <input type="number" id="characterCount" min="1" max="10" value="2" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5 h-11" required>
                         <div class="flex items-center gap-2">
                             <label for="characterCountToggle" class="text-sm font-medium text-gray-400 whitespace-nowrap">آلي</label>
                             <button type="button" id="characterCountToggle" class="toggle-switch" role="switch" aria-checked="false"><span class="toggle-knob"></span></button>
                        </div>
                    </div>
                </div>
                <div class="col-span-1 md:col-span-2">
                    <label for="details" class="block mb-2 text-sm font-medium text-gray-300">تفاصيل إضافية (اختياري)</label>
                    <textarea id="details" rows="4" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5" placeholder="مثال: البطل هو فارس صغير شجاع، ومعه ثعلب حكيم كرفيق."></textarea>
                </div>
                <div class="col-span-1 md:col-span-2 text-center">
                     <button type="submit" id="generateBtn" class="text-white bg-indigo-600 hover:bg-indigo-700 focus:ring-4 focus:outline-none focus:ring-indigo-500 font-medium rounded-lg text-lg w-full sm:w-auto px-8 py-3 text-center transition-all duration-300 ease-in-out shadow-lg hover:shadow-indigo-500/50">
                        <span id="btn-text">إنشاء السيناريو</span>
                        <svg id="loader" class="spinner h-5 w-5 text-white mx-auto hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                </div>
            </form>
            <div id="outputContainer" class="mt-8 col-span-1 md:col-span-2 hidden">
                 <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                    <h2 class="text-2xl font-bold text-indigo-300">السيناريو المقترح</h2>
                    <div class="flex gap-2">
                       <button id="summarizeBtn" class="hidden text-white bg-purple-600 hover:bg-purple-700 focus:ring-4 focus:outline-none focus:ring-purple-500 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-all duration-300">تلخيص وعناوين ✨</button>
                       <button id="downloadBtn" class="hidden text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:outline-none focus:ring-green-500 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-all duration-300">تنزيل كـ Word</button>
                    </div>
                 </div>
                 <div id="scriptOutput" class="bg-gray-900 p-6 rounded-lg border border-gray-700 min-h-[200px] text-gray-300"></div>
            </div>
        </main>
    </div>

    <!-- Modals Container -->
    <div id="guideModal" class="modal-overlay hidden"></div>
    <div id="suggestionModal" class="modal-overlay hidden"></div>
    <div id="summaryModal" class="modal-overlay hidden"></div>
    <div id="apiKeyModal" class="modal-overlay hidden"></div>

    <script>
        // --- DOM Elements ---
        const scriptForm = document.getElementById('scriptForm');
        const generateBtn = document.getElementById('generateBtn');
        const btnText = document.getElementById('btn-text');
        const loader = document.getElementById('loader');
        const outputContainer = document.getElementById('outputContainer');
        const scriptOutput = document.getElementById('scriptOutput');
        const downloadBtn = document.getElementById('downloadBtn');
        const topicInput = document.getElementById('topic');
        const sceneCountInput = document.getElementById('sceneCount');
        const sceneCountToggle = document.getElementById('sceneCountToggle');
        const characterCountInput = document.getElementById('characterCount');
        const characterCountToggle = document.getElementById('characterCountToggle');

        // Modals & Buttons
        const openGuideBtn = document.getElementById('openGuideBtn');
        const guideModal = document.getElementById('guideModal');
        const openApiSettingsBtn = document.getElementById('openApiSettingsBtn');
        const apiKeyModal = document.getElementById('apiKeyModal');
        const suggestIdeasBtn = document.getElementById('suggestIdeasBtn');
        const suggestionModal = document.getElementById('suggestionModal');
        const summarizeBtn = document.getElementById('summarizeBtn');
        const summaryModal = document.getElementById('summaryModal');

        const inputsToSave = ['topic', 'videoType', 'videoTone', 'sceneCount', 'characterCount', 'details'];
        
        // --- Speech Synthesis Setup ---
        let voices = [];
        let arabicVoice = null;

        function loadVoices() {
            voices = window.speechSynthesis.getVoices();
            arabicVoice = voices.find(voice => voice.lang.startsWith('ar')) || voices.find(voice => voice.default);
        }
        loadVoices();
        if (window.speechSynthesis.onvoiceschanged !== undefined) {
            window.speechSynthesis.onvoiceschanged = loadVoices;
        }

        // --- Event Listeners ---
        function setupModal(button, modal, asyncAction = null) {
            if (button) button.addEventListener('click', () => {
                // Always get fresh content for the guide modal to ensure state is correct
                if (modal.id === 'guideModal' || modal.innerHTML.trim() === '') {
                    modal.innerHTML = getModalContent(modal.id);
                    bindModalContentEvents(modal);
                }
                modal.classList.remove('hidden');
                if(asyncAction) asyncAction(modal);
            });
        }
        
        function bindModalContentEvents(modal) {
             const closeBtn = modal.querySelector('.modal-close-btn');
             if (closeBtn) closeBtn.addEventListener('click', () => modal.classList.add('hidden'));
             modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.add('hidden'); });

             if (modal.id === 'guideModal') {
                const guideTabs = modal.querySelectorAll('.tab-button');
                const guidePanels = modal.querySelectorAll('.tab-panel');

                guideTabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        // Reset all tabs to inactive style
                        guideTabs.forEach(t => {
                            t.classList.remove('active', 'text-indigo-400');
                            t.classList.add('text-gray-400', 'hover:text-gray-300', 'hover:border-gray-500');
                        });
                        // Hide all panels
                        guidePanels.forEach(p => p.classList.add('hidden'));

                        // Activate the clicked tab
                        tab.classList.add('active', 'text-indigo-400');
                        tab.classList.remove('text-gray-400', 'hover:text-gray-300', 'hover:border-gray-500');

                        // Show the corresponding panel
                        const panelId = tab.dataset.tab;
                        const panel = modal.querySelector(`#${panelId}`);
                        if (panel) panel.classList.remove('hidden');
                    });
                });
            }
             if(modal.id === 'apiKeyModal') {
                 modal.querySelector('#saveApiKeyBtn')?.addEventListener('click', () => {
                    const apiKeyInput = modal.querySelector('#apiKeyInput');
                    const apiKeyStatus = modal.querySelector('#apiKeyStatus');
                    const userKey = apiKeyInput.value.trim();
                    localStorage.setItem('userGeminiApiKey', userKey);
                    apiKeyStatus.textContent = userKey ? 'تم حفظ المفتاح بنجاح!' : 'تم إزالة المفتاح المحفوظ.';
                    setTimeout(() => { if(apiKeyStatus) apiKeyStatus.textContent = '' }, 3000);
                });
             }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            setupModal(openGuideBtn, guideModal);
            setupModal(openApiSettingsBtn, apiKeyModal);
            setupModal(suggestIdeasBtn, suggestionModal, fetchAndShowSuggestions);
            setupModal(summarizeBtn, summaryModal, fetchAndShowSummary);

            // Autosave Logic
            inputsToSave.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    const savedValue = localStorage.getItem(`scriptgen_${id}`);
                    if (savedValue) input.value = savedValue;
                    input.addEventListener('input', () => localStorage.setItem(`scriptgen_${id}`, input.value));
                }
            });
            ['sceneCountToggle', 'characterCountToggle'].forEach(id => {
                 const toggle = document.getElementById(id);
                 if(toggle) {
                    const savedValue = localStorage.getItem(`scriptgen_${id}`) === 'true';
                    toggle.setAttribute('aria-checked', savedValue);
                    document.getElementById(id.replace('Toggle', '')).disabled = savedValue;
                 }
            });
        });

        function getModalContent(modalId) {
            const spinner = `<div class="w-full h-48 flex items-center justify-center"><svg class="modal-spinner h-10 w-10 text-indigo-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>`;
            switch(modalId) {
                case 'guideModal': return `<div class="modal-content relative"><button class="modal-close-btn">&times;</button><h2 class="text-2xl font-bold text-indigo-300 mb-6">دليل صناعة الفيديو بالذكاء الاصطناعي</h2><div class="border-b border-gray-600 mb-6"><nav class="flex sm:space-x-4 -mb-px flex-col sm:flex-row" aria-label="Tabs"><button data-tab="tab-tts" class="tab-button active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-indigo-400">1. أدوات الصوت (TTS)</button><button data-tab="tab-tti" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-300 hover:border-gray-500">2. أدوات الصور (TTI)</button><button data-tab="tab-editing" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-300 hover:border-gray-500">3. أدوات المونتاج</button></nav></div><div><div id="tab-tts" class="tab-panel space-y-4"><ul><li><a href="https://elevenlabs.io/" target="_blank" class="guide-link">ElevenLabs</a><div class="tool-description">يعتبر الأقوى حاليًا في جودة وواقعية الأصوات. يمكنك استنساخ صوتك أو استخدام أصوات جاهزة عالية الجودة.<p class="limit-note">يقدم خطة مجانية تمنحك 10,000 حرف شهريًا و 3 أصوات مخصصة.</p></div></li><li><a href="https://openai.com/blog/openai-text-to-speech-api" target="_blank" class="guide-link">OpenAI TTS</a><div class="tool-description">يوفر أصواتًا طبيعية جدًا ومناسبة لمختلف الاستخدامات، مدمجة في العديد من التطبيقات.<p class="limit-note">يتطلب مفتاح API للاستخدام المباشر، ولكنه متاح عبر خدمات أخرى.</p></div></li></ul></div><div id="tab-tti" class="tab-panel space-y-4 hidden"><ul><li><a href="https://leonardo.ai/" target="_blank" class="guide-link">Leonardo.Ai</a><div class="tool-description">منصة متكاملة وقوية جدًا، تقدم نماذج مدربة مسبقًا لإنتاج أنماط فنية معينة.<p class="limit-note">يمنحك 150 "عملة" مجانية يوميًا، تتجدد كل 24 ساعة.</p></div></li><li><a href="https://www.bing.com/images/create" target="_blank" class="guide-link">Bing Image Creator</a><div class="tool-description">مدعوم بنموذج DALL-E 3 من OpenAI، وهو مجاني بالكامل. يقدم صورًا عالية الجودة.<p class="limit-note">يمنحك "معززات" يومية لتسريع عملية الإنشاء.</p></div></li></ul></div><div id="tab-editing" class="tab-panel space-y-4 hidden"><h3 class="text-xl font-bold text-indigo-400">برامج المونتاج المقترحة</h3><ul class="list-disc list-inside space-y-3"><li><strong>للجميع (كمبيوتر وهاتف):</strong> <a href="https://www.capcut.com/" target="_blank" class="guide-link">CapCut</a> (الأسهل والأكثر شعبية للمبتدئين).</li><li><strong>للكومبيوتر (للمبتدئين):</strong> <a href="https://clipchamp.com/en/" target="_blank" class="guide-link">Clipchamp</a> (مدمج في Windows ومتاح أونلاين).</li><li><strong>للكومبيوتر (للمحترفين):</strong> <a href="https://www.blackmagicdesign.com/products/davinciresolve" target="_blank" class="guide-link">DaVinci Resolve</a> (احترافي وقوي جدًا، ويحتوي على نسخة مجانية ممتازة).</li></ul></div></div></div>`;
                case 'apiKeyModal': return `<div class="modal-content relative"><button class="modal-close-btn">&times;</button><div class="space-y-6"><h2 class="text-2xl font-bold text-indigo-300">إعدادات مفتاح API الخاص بك</h2><p class="text-gray-400">أضف مفتاح Gemini API الخاص بك لتجنب حدود الاستخدام.</p><div><label for="apiKeyInput" class="block mb-2 text-sm font-medium text-gray-300">مفتاح Gemini API</label><input type="password" id="apiKeyInput" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5" placeholder="أدخل مفتاح API الخاص بك هنا" value="${localStorage.getItem('userGeminiApiKey') || ''}"></div><div class="flex items-center justify-between"><button id="saveApiKeyBtn" class="text-white bg-indigo-600 hover:bg-indigo-700 focus:ring-4 focus:outline-none focus:ring-indigo-500 font-medium rounded-lg text-sm px-5 py-2.5 text-center">حفظ المفتاح</button><span id="apiKeyStatus" class="text-green-400 text-sm"></span></div><details class="bg-gray-800 rounded-lg p-4"><summary class="cursor-pointer font-medium text-indigo-400">كيف أحصل على مفتاح API؟</summary><div class="mt-4 space-y-2 text-gray-300"><ol class="list-decimal list-inside space-y-2 pr-4"><li>اذهب إلى <a href="https://aistudio.google.com/app/apikey" target="_blank" class="guide-link">صفحة مفاتيح API في Google AI Studio</a>.</li><li>اضغط على "Create API key in new project".</li><li>انسخ المفتاح وألصقه في الحقل بالأعلى.</li></ol></div></details></div></div>`;
                case 'suggestionModal': return `<div class="modal-content relative"><button class="modal-close-btn">&times;</button><h2 class="text-2xl font-bold text-indigo-300 mb-6">أفكار مقترحة</h2><div id="suggestionList" class="space-y-3">${spinner}</div></div>`;
                case 'summaryModal': return `<div class="modal-content relative"><button class="modal-close-btn">&times;</button><h2 class="text-2xl font-bold text-indigo-300 mb-6">✨ الملخص والعناوين المقترحة</h2><div id="summaryContent" class="space-y-4">${spinner}</div></div>`;
                default: return `<div class="modal-content relative"><button class="modal-close-btn">&times;</button></div>`;
            }
        }

        function setupToggle(toggle, input) {
            toggle.addEventListener('click', () => {
                const isChecked = toggle.getAttribute('aria-checked') === 'true';
                toggle.setAttribute('aria-checked', !isChecked);
                input.disabled = !isChecked;
                localStorage.setItem(`scriptgen_${toggle.id}`, !isChecked);
            });
        }
        setupToggle(sceneCountToggle, sceneCountInput);
        setupToggle(characterCountToggle, characterCountInput);
        
        scriptForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            outputContainer.classList.add('hidden');
            downloadBtn.classList.add('hidden');
            summarizeBtn.classList.add('hidden');
            const topic = topicInput.value, videoType = document.getElementById('videoType').value, videoTone = document.getElementById('videoTone').value, details = document.getElementById('details').value;
            const sceneCount = sceneCountToggle.getAttribute('aria-checked') === 'true' ? "حسب الحاجة" : sceneCountInput.value;
            const characterCount = characterCountToggle.getAttribute('aria-checked') === 'true' ? "حسب الحاجة" : characterCountInput.value;

            if (!topic.trim()) { scriptOutput.innerHTML = `<p class="text-yellow-400 text-center">الرجاء إدخال موضوع الفيديو.</p>`; outputContainer.classList.remove('hidden'); return; }
            showLoading(true);
            const prompt = `أنت خبير في كتابة الموجهات (Prompts) لإنتاج محتوى بالذكاء الاصطناعي. مهمتك هي إنشاء سيناريو مجزأ. **البيانات المدخلة:** - **الموضوع الرئيسي:** ${topic} - **الأسلوب الفني المطلوب:** ${videoType} - **نبرة الفيديو:** ${videoTone} - **عدد المشاهد:** ${sceneCount} - **عدد الشخصيات:** ${characterCount} - **تفاصيل إضافية:** ${details || 'لا يوجد'} **التعليمات الصارمة للإخراج:** 1. حدد العدد المناسب من الشخصيات والمشاهد إذا كان "حسب الحاجة". 2. يجب أن يعكس الحوار وأجواء القصة النبرة المطلوبة: **${videoTone}**. 3. لكل مشهد، ابدأ بعنوان باستخدام الماركدون هكذا: "### المشهد [رقم المشهد]: [اسم وصفي]". 4. **موجه الصورة (Image Prompt):** بعد العنوان، اكتب موجهًا (prompt) لتوليد صورة للمشهد باللغة الإنجليزية. ركز على: **Subject, Setting, Lighting, Colors, Composition, and Art Style (${videoType})**. **مهم جداً:** ضع هذا الموجه كاملاً داخل وسم HTML خاص هكذا: \`<div class="image-prompt">[Your English image prompt here]</div>\`. 5. **الحوار:** بعد موجه الصورة، اكتب الحوار باللغة العربية. **مهم جداً:** إذا كان هناك وصف للنبرة أو الفعل (مثل "يضحك" أو "بهمس")، ضعه بين قوسين قبل وسم \`<span>\`. يجب أن يحتوي وسم \`<span>\` على الحوار الفعلي فقط. 6. استخدم هذا التنسيق الدقيق لكل سطر حوار: \`<div class="dialogue-line"><div class="dialogue-text-content"><strong>الشخصية:</strong> (الوصف الصوتي إن وجد) <span>الحوار الفعلي فقط</span></div></div>\`.`;
            try {
                const result = await callGeminiAPI(prompt);
                renderScript(result);
                outputContainer.classList.remove('hidden'); downloadBtn.classList.remove('hidden'); summarizeBtn.classList.remove('hidden');
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                let errorMessage = `حدث خطأ أثناء إنشاء السيناريو. الرجاء المحاولة مرة أخرى.`;
                if (error.message.includes('API key not valid')) { errorMessage = 'مفتاح API الذي أدخلته غير صالح. يرجى التحقق منه في الإعدادات أو إزالته لاستخدام المفتاح الافتراضي.' }
                scriptOutput.innerHTML = `<p class="text-red-400 text-center">${errorMessage}</p>`;
                outputContainer.classList.remove('hidden');
            } finally {
                showLoading(false);
                outputContainer.scrollIntoView({ behavior: 'smooth' });
            }
        });
        
        function renderScript(text) {
            let processedHtml = text
                .replace(/<div class="image-prompt">([\s\S]*?)<\/div>/g, (match, p1) => {
                    const promptText = p1.trim();
                    return `<div class="image-prompt-box">
                                <div class="prompt-actions">
                                    <button class="prompt-btn copy-prompt-btn" title="نسخ الموجه">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                                        <div class="copy-tooltip">تم النسخ!</div>
                                    </button>
                                </div>
                                <pre class="whitespace-pre-wrap"><code>${promptText}</code></pre>
                            </div>`;
                })
                .replace(/<div class="dialogue-line">([\s\S]*?)<\/div>/g, (match, p1) => {
                    return `<div class="dialogue-line-box">
                                ${p1}
                                <div class="dialogue-actions-container">
                                    <button class="dialogue-action-btn dialogue-tts-btn" title="استمع للحوار">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>
                                    </button>
                                    <button class="dialogue-action-btn dialogue-copy-btn" title="نسخ الحوار">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                                        <div class="copy-tooltip">تم النسخ!</div>
                                    </button>
                                </div>
                            </div>`;
                });
            scriptOutput.innerHTML = marked.parse(processedHtml);
            addCopyListeners();
            addTTSListeners();
        }

        function addCopyListeners() {
            document.querySelectorAll('.copy-prompt-btn').forEach(btn => {
                btn.addEventListener('click', () => copyToClipboard(btn, btn.closest('.image-prompt-box').querySelector('code').innerText));
            });
            document.querySelectorAll('.dialogue-copy-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const dialogueSpan = btn.closest('.dialogue-line-box').querySelector('.dialogue-text-content span');
                    if (dialogueSpan) copyToClipboard(btn, dialogueSpan.innerText);
                });
            });
        }
        
        function addTTSListeners() {
            document.querySelectorAll('.dialogue-tts-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                     const dialogueSpan = btn.closest('.dialogue-line-box').querySelector('.dialogue-text-content span');
                     if (dialogueSpan) speakText(btn, dialogueSpan.innerText);
                });
            });
        }
        
        function speakText(button, text) {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
                document.querySelectorAll('.dialogue-tts-btn.playing').forEach(b => b.classList.remove('playing'));
            }
            const utterance = new SpeechSynthesisUtterance(text);
            if (arabicVoice) {
                utterance.voice = arabicVoice;
                utterance.lang = arabicVoice.lang;
            } else {
                 utterance.lang = 'ar-SA';
            }
            utterance.onstart = () => button.classList.add('playing');
            utterance.onend = () => button.classList.remove('playing');
            utterance.onerror = () => button.classList.remove('playing');
            speechSynthesis.speak(utterance);
        }

        function copyToClipboard(button, text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try { document.execCommand('copy'); } catch (err) { console.error('Fallback: Oops, unable to copy', err); }
            document.body.removeChild(textarea);
            button.classList.add('copied');
            setTimeout(() => button.classList.remove('copied'), 2000);
        }

        async function fetchAndShowSuggestions(modal) {
            const listEl = modal.querySelector('#suggestionList');
            try {
                const prompt = "اقترح 5 أفكار متنوعة ومبتكرة لقصص قصيرة يمكن تحويلها إلى فيديو. قدم الأفكار كنقاط في قائمة مرقمة باللغة العربية. مثال: 1. رائد فضاء يكتشف كوكبًا مصنوعًا من الحلوى.";
                const result = await callGeminiAPI(prompt);
                const ideas = result.match(/\d+\.\s(.+)/g).map(idea => idea.replace(/\d+\.\s/, '').trim());
                listEl.innerHTML = ideas.map(idea => `<div class="suggestion-item">${idea}</div>`).join('');
                listEl.querySelectorAll('.suggestion-item').forEach(item => {
                    item.addEventListener('click', () => {
                        topicInput.value = item.textContent;
                        modal.classList.add('hidden');
                    });
                });
            } catch(e) { listEl.innerHTML = '<p class="text-red-400">فشل في جلب الاقتراحات.</p>'; }
        }
        
        async function fetchAndShowSummary(modal) {
            const contentEl = modal.querySelector('#summaryContent');
            const scriptText = scriptOutput.innerText;
            if (!scriptText) { contentEl.innerHTML = '<p>لا يوجد سيناريو لتلخيصه.</p>'; return; }
            try {
                const prompt = `بناءً على السيناريو التالي، قم بما يلي: 1. اكتب ملخصًا للقصة في فقرة واحدة. 2. اقترح 3 عناوين جذابة ومختلفة للفيديو. استخدم تنسيق ماركداون: ### الملخص ... ### عناوين مقترحة ...`;
                const result = await callGeminiAPI(prompt + "\n\n---\n\n" + scriptText);
                contentEl.innerHTML = marked.parse(result);
            } catch(e) { contentEl.innerHTML = '<p class="text-red-400">فشل في إنشاء الملخص.</p>'; }
        }

        downloadBtn.addEventListener('click', () => {
            let content = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Video Script</title></head><body dir="rtl" style="font-family: Arial, sans-serif;">`;
            content += scriptOutput.innerHTML
                .replace(/<button.*?<\/button>/g, '') // Remove buttons
                .replace(/class="[^"]*"/g, ''); // Remove classes
            content += '</body></html>';
            const converted = htmlDocx.asBlob(content);
            saveAs(converted, `سيناريو-${topicInput.value.replace(/ /g, '_') || 'جديد'}.docx`);
        });

        function showLoading(isLoading) {
            btnText.classList.toggle('hidden', isLoading);
            loader.classList.toggle('hidden', !isLoading);
            generateBtn.disabled = isLoading;
        }
        
        async function callGeminiAPI(prompt) {
            const userApiKey = localStorage.getItem('userGeminiApiKey');
            const apiKey = userApiKey || "AIzaSyD-k6ktF79zk89e-GCMP_yWVtvvUz_OS1Q"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) {
                const errorData = await response.json();
                const message = errorData.error?.message || response.statusText;
                if (message.includes('API key not valid')) { throw new Error('API key not valid'); }
                throw new Error(message);
            }
            const result = await response.json();
            if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                return result.candidates[0].content.parts[0].text;
            } else {
                let reason = result.candidates?.[0]?.finishReason;
                let safetyMessage = "";
                if (reason === 'SAFETY') {
                    safetyMessage = "تم حظر الرد بسبب سياسات السلامة."
                }
                throw new Error(`لم يتمكن الذكاء الاصطناعي من إنشاء رد. ${safetyMessage}`);
            }
        }
    </script>
</body>
</html>
